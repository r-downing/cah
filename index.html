<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<title>CAH</title>

	<link rel="stylesheet" type="text/css" href="style.css">

	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

	<script src="cards.js"></script>
	<script src="config.js"></script>
	<script src="utils.js"></script>
	<script>
		var roomNumber;
		var blackID = null;
		var questionCards = [];
		var answerCards = [];
		var roomcode;
		var numAnswers = 1;
		var multiselected = [];


		function redraw() {
			$.getJSON(host + "game/" + roomNumber + '/draw', function (data) {
				console.log('draw ' + data);
				$('#whitecards').empty();
				for (let i = 0; i < 5; i++) {
					let cid = ((roomNumber + 5 * data) + i) % answerCards.length
					c = $('<div></div>').addClass('whitecard').html(answerCards[cid]).appendTo($('#whitecards')).click(function (event) {
						let target = $(event.target);
						if (target.hasClass('multiselect')) {
							multiselected = [];
						}
						else {
							multiselected.push(cid);
						}
						target.toggleClass('multiselect');
						if (multiselected.length == numAnswers) {
							$('#whitecards').empty();
							$.getJSON(host + "game/" + roomNumber + '/submit/' + multiselected.join('_'), function (data) {
								multiselected = [];
								refresh();
							});
						}
					}).hide().fadeIn("slow");
				}
			});
		};


		function refresh() {
			$.getJSON(host + "game/" + roomNumber, function (data) {
				console.log(data);
				if (blackID != data['black']) {
					blackID = data['black']
					let cardData = questionCards[(roomNumber + blackID) % questionCards.length];
					numAnswers = cardData["numAnswers"];
					$('#black').html(cardData["text"].replace(/_/g, '_____')).hide().fadeIn("slow");
					if (!data['revealed']) {
						redraw();
					}
				}
				$('#played .whitecard').remove();
				if(!data['revealed'] && data['submitted'].length)
				{
					$('<div></div>').addClass('whitecard').attr('id', 'counter').appendTo('#played').html(data['submitted'].length).click(function() {
						reveal();
					});
				}
				if (data['revealed']) {
					$('#whitecards').empty();
					data['submitted'].forEach(element => {
					cardIDs = element.split('_').map(x => parseInt(x));
					txt = cardIDs.map(x => answerCards[x]).join('<p>-----</p>')
					let d = $('<div></div>').addClass('whitecard').html(txt).appendTo($('#played')).click(function () {
							$.getJSON(host + "game/" + roomNumber + '/winner/' + element, function (data) {
								refresh();
							});
					});
					if (data['winner'] == element) {
						d.css('background-color', 'green');
					}
				});
				}
			});
		};

		function newgame() {
			$.getJSON(host + "game/" + roomNumber + '/new', function (data) {
				refresh();
			});
		}

		function reveal() {
			$.getJSON(host + "game/" + roomNumber + '/reveal', function (data) {
				refresh();
			});
		}


		$(document).ready(() => {
			rawcards.forEach(e => {
				if (e["cardType"] == "A") {
					answerCards.push(e["text"]);
				}
				else if (e["cardType"] == "Q" && e["numAnswers"] <= 2) {
					questionCards.push(e);
				}
			});
			if (window.location.href.indexOf('?') == -1) {
				roomcode = encodeURIComponent(prompt("enter room code:"));
				window.location.href = window.location.href + '?' + roomcode;
			}
			else {
				roomcode = window.location.href.substring(window.location.href.lastIndexOf('?') + 1);
			}

			document.title = "Room code: " + roomcode;
			roomNumber = hashCode(roomcode);


			rndfunc = xoshiro128ss(4, 5, 8, roomNumber);
			for (var i = 0; i < answerCards.length; i++) {
				var tmp = answerCards[i];
				r = Math.floor(rndfunc() * answerCards.length);
				answerCards[i] = answerCards[r];
				answerCards[r] = tmp;
			}

			for (var i = 0; i < questionCards.length; i++) {
				var tmp = questionCards[i];
				r = Math.floor(rndfunc() * questionCards.length);
				questionCards[i] = questionCards[r];
				questionCards[r] = tmp;
			}

			refresh();
			$('#black').click(newgame);
			$('#reveal').click(reveal);
			setInterval(refresh, 4000);
		});


	</script>
</head>

<body>

	<div id="played" class="cardlist">
		<div id="black"></div>
	</div>

	<hr />

	<div id="whitecards" class="cardlist"></div>

</body>

</html>
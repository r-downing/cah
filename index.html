<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<title>CAH</title>

	<style>
		body {
			font-family: Helvetica, Arial, sans-serif;
			font-weight: bold;
		}

		#black {
			color: white;
			background-color: black;
		}

		#black,
		.whitecard {
			width: 10em;
			min-height: 5em;
			display: flex;
			/* align-items: center; */
			margin: .5em;
			padding: 1em;
			border-radius: .75em;
		}

		@media screen and (min-width: 40em) {

			#black,
			.whitecard {
				min-height: 10em;
			}
		}

		.whitecard {
			border: 1px solid black;
		}

		.whitecard:hover {
			background-color: gray;
		}

		#whitecards,
		#submitted {
			display: flex;
			flex-wrap: wrap;
		}
	</style>

	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

	<script src="cards.js"></script>
	<script>
		var host = "https://rdowning.pythonanywhere.com/";
		var roomNumber;
		var black = null;
		var draw = null;
		var questionCards = [];
		var answerCards = [];
		var roomcode;

		hashCode = function (s) {
			return s.split("").reduce(function (a, b) { a = ((a << 5) - a) + b.charCodeAt(0); return a & a }, 0);
		}

		function xoshiro128ss(a, b, c, d) {
			return function () {
				var t = b << 9, r = a * 5; r = (r << 7 | r >>> 25) * 9;
				c ^= a; d ^= b;
				b ^= c; a ^= d; c ^= t;
				d = d << 11 | d >>> 21;
				return (r >>> 0) / 4294967296;
			}
		}

		function redraw() {
			$.getJSON(host + "game/" + roomNumber + '/draw', function (data) {
				console.log('draw ' + data);
				$('#whitecards').empty();
				for (let i = 0; i < 5; i++) {
					let cid = ((roomNumber + 5 * data) + i) % answerCards.length
					c = $('<div></div>').addClass('whitecard').html(answerCards[cid]).appendTo($('#whitecards')).click(function () {
						$('#whitecards').empty();
						$.getJSON(host + "game/" + roomNumber + '/submit/' + cid, function (data) {

						});
						console.log(i);
					})
				}
			});
		};


		function refresh() {
			$.getJSON(host + "game/" + roomNumber, function (data) {
				console.log(data);
				if (black != data['black']) {
					black = data['black']
					$('#black').html(questionCards[(roomNumber + black) % questionCards.length]);
					if(!data['revealed']){
						redraw();
					}
				}
				$('#submitted').empty();
				$('#submitted').css('display', data['revealed'] ? 'flex' : 'none');
				$('#subcnt').html(data['submitted'].length);
				data['submitted'].forEach(element => {
					let d = $('<div></div>').addClass('whitecard').html(answerCards[element]).appendTo($('#submitted')).click(function () {
						$.getJSON(host + "game/" + roomNumber + '/winner/' + element, function (data) {
							refresh();
						});
					});
					if (data['winner'] == element) {
						d.css('background-color', 'green');
					}
				});
				if (data['revealed']) {
					$('#whitecards').empty();
				}
			});
		};

		function newgame() {
			$.getJSON(host + "game/" + roomNumber + '/new', function (data) {
				refresh();
			});
		}

		function reveal() {
			$.getJSON(host + "game/" + roomNumber + '/reveal', function (data) {
				$('#submitted').css('display', 'block');
			});
		}


		$(document).ready(() => {
			rawcards.forEach(e => {
				if (e["cardType"] == "A") {
					answerCards.push(e["text"]);
				}
				else if (e["cardType"] == "Q" && e["numAnswers"] == 1) {
					questionCards.push(e["text"]);
				}
			});
			if (window.location.href.indexOf('?') == -1) {
				roomcode = encodeURIComponent(prompt("enter room code:"));
				window.location.href = window.location.href + '?' + roomcode;
			}
			else {
				roomcode = window.location.href.substring(window.location.href.lastIndexOf('?') + 1);
			}

			document.title = "Room code: " + roomcode;
			roomNumber = hashCode(roomcode);


			rndfunc = xoshiro128ss(4, 5, 8, roomNumber);
			for (var i = 0; i < answerCards.length; i++) {
				var tmp = answerCards[i];
				r = Math.floor(rndfunc() * answerCards.length);
				answerCards[i] = answerCards[r];
				answerCards[r] = tmp;
			}

			for (var i = 0; i < questionCards.length; i++) {
				var tmp = questionCards[i];
				r = Math.floor(rndfunc() * questionCards.length);
				questionCards[i] = questionCards[r];
				questionCards[r] = tmp;
			}

			refresh();
			$('#newgame').click(newgame);
			$('#reveal').click(reveal);
			setInterval(refresh, 5000);
		});


	</script>
</head>

<body>

	<div id="black"></div>
	<br />
	Submitted: <span id="subcnt"></span>. <button id="reveal">Reveal</button>
	<div id="submitted"></div>
	<br />
	<div id="whitecards"></div>
	<br />
	<button id='newgame'>new round</button>
</body>

</html>